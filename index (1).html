<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SEAL — Polymarket Prop Firm</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ==========================================
// CONFIG — PASTE YOUR KEYS HERE
// ==========================================
const SUPABASE_URL = 'https://iyaqyoxezkovuusooomgf.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5YXF5b3hlemtvdnV1c29vbWdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NTM3NDcsImV4cCI6MjA4NzUyOTc0N30.9dja2T1r2AlgytvQWuQO2exoGTdPcIVM0VQXp1MWB7Q';

// Stripe Payment Links — create these in Stripe Dashboard
const STRIPE_LINKS = {
  '1step-500':  'STRIPE_LINK_1STEP_500',   // $79
  '1step-1000': 'STRIPE_LINK_1STEP_1000',  // $139
  '1step-2000': 'STRIPE_LINK_1STEP_2000',  // $199
  '2step-500':  'STRIPE_LINK_2STEP_500',   // $59
  '2step-1000': 'STRIPE_LINK_2STEP_1000',  // $119
  '2step-2000': 'STRIPE_LINK_2STEP_2000',  // $179
};
// ==========================================
</script>
<style>
:root{--bg:#04060a;--bg2:#080c14;--bg3:#0c1220;--bg4:#12192a;--border:#141e30;--border2:#1c2840;--text:#c0c8d8;--text2:#7888a4;--text3:#4a5878;--accent:#3888e8;--accent2:#2a6cc4;--accentglow:rgba(56,136,232,0.06);--red:#d04848;--yellow:#c8a030;--green:#40b080;--mono:'JetBrains Mono','Menlo',monospace;--sans:'Outfit',sans-serif}
*{margin:0;padding:0;box-sizing:border-box}
html{font-size:16px;scroll-behavior:smooth}
body{background:var(--bg);color:var(--text);font-family:var(--sans);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.025'/%3E%3C/svg%3E");pointer-events:none;z-index:9999}
nav{position:fixed;top:0;left:0;right:0;height:56px;background:rgba(4,6,10,0.94);backdrop-filter:blur(16px);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 24px;z-index:100}
.nav-logo{font-family:var(--mono);font-weight:700;font-size:15px;letter-spacing:3px;color:#fff;display:flex;align-items:center;gap:8px;cursor:pointer}
.nav-logo .dot{width:6px;height:6px;background:var(--accent);border-radius:50%}
.nav-links{display:flex;gap:0}
.nav-links a{font-family:var(--mono);font-size:11px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);text-decoration:none;padding:18px 14px;transition:color 0.2s;cursor:pointer;border-bottom:2px solid transparent}
.nav-links a:hover{color:var(--text2)}
.nav-links a.active{color:var(--accent);border-bottom-color:var(--accent)}
.nav-links a.auth-only{display:none}
.nav-links a.admin-only{display:none}
.nav-right{display:flex;align-items:center;gap:12px}
.nav-user{font-family:var(--mono);font-size:11px;color:var(--text3);display:none}
.nav-cta{font-family:var(--mono);font-size:11px;letter-spacing:1px;background:var(--accent);color:#fff;padding:8px 18px;border:none;cursor:pointer;font-weight:600;text-transform:uppercase;transition:background 0.2s}
.nav-cta:hover{background:var(--accent2)}
.nav-cta.ghost{background:transparent;border:1px solid var(--border2);color:var(--text3)}
.nav-cta.ghost:hover{border-color:var(--text3);color:var(--text)}
.page{display:none;padding-top:56px;min-height:100vh}
.page.active{display:block}
.hero{padding:100px 32px 80px;text-align:center;position:relative;overflow:hidden}
.hero::before{content:'';position:absolute;top:-100px;left:50%;transform:translateX(-50%);width:800px;height:800px;background:radial-gradient(circle,var(--accentglow) 0%,transparent 60%);pointer-events:none}
.hero-tag{font-family:var(--mono);font-size:11px;letter-spacing:3px;text-transform:uppercase;color:var(--accent);margin-bottom:24px}
.hero h1{font-family:var(--sans);font-weight:700;font-size:48px;color:#fff;line-height:1.1;margin-bottom:20px;letter-spacing:-1px}
.hero h1 span{color:var(--accent)}
.hero p{font-size:17px;color:var(--text2);max-width:560px;margin:0 auto 40px;line-height:1.6}
.hero-buttons{display:flex;gap:12px;justify-content:center}
.btn{font-family:var(--mono);font-size:12px;letter-spacing:1px;padding:14px 32px;border:none;cursor:pointer;font-weight:600;text-transform:uppercase;transition:all 0.2s}
.btn-primary{background:var(--accent);color:#fff}.btn-primary:hover{background:var(--accent2)}
.btn-ghost{background:transparent;color:var(--text2);border:1px solid var(--border2)}.btn-ghost:hover{border-color:var(--text3);color:var(--text)}
.section{padding:80px 32px;max-width:1100px;margin:0 auto}
.section-tag{font-family:var(--mono);font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--accent);margin-bottom:12px}
.section h2{font-family:var(--sans);font-weight:600;font-size:32px;color:#fff;margin-bottom:48px;letter-spacing:-0.5px}
.steps{display:grid;grid-template-columns:repeat(3,1fr);gap:24px}
.step{background:var(--bg2);border:1px solid var(--border);padding:32px;position:relative}
.step-num{font-family:var(--mono);font-size:48px;font-weight:700;color:var(--border2);position:absolute;top:16px;right:20px}
.step h3{font-family:var(--mono);font-size:13px;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:var(--accent);margin-bottom:12px}
.step p{font-size:14px;color:var(--text2);line-height:1.6}
footer{border-top:1px solid var(--border);padding:40px 32px;text-align:center;font-family:var(--mono);font-size:10px;letter-spacing:1px;color:var(--text3);text-transform:uppercase}
/* CHALLENGES */
.challenge-toggle{display:flex;justify-content:center;margin-bottom:40px}
.challenge-toggle button{font-family:var(--mono);font-size:12px;letter-spacing:1.5px;text-transform:uppercase;padding:12px 32px;border:1px solid var(--border2);background:var(--bg2);color:var(--text3);cursor:pointer;transition:all 0.2s}
.challenge-toggle button.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.challenge-toggle button:first-child{border-right:none}
.challenge-set{display:none}
.challenge-set.active{display:grid;grid-template-columns:repeat(3,1fr);gap:24px;max-width:1100px;margin:0 auto}
.challenge-card{background:var(--bg2);border:1px solid var(--border);overflow:hidden;position:relative}
.challenge-card.feat{border-color:var(--accent)}
.challenge-card.feat::before{content:'MOST POPULAR';position:absolute;top:0;left:0;right:0;background:var(--accent);color:#fff;text-align:center;font-family:var(--mono);font-size:9px;letter-spacing:2px;padding:6px;font-weight:700}
.ch-header{padding:36px 28px 20px;border-bottom:1px solid var(--border)}
.challenge-card.feat .ch-header{padding-top:52px}
.ch-size{font-family:var(--mono);font-size:36px;font-weight:700;color:#fff}
.ch-label{font-family:var(--mono);font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--text3);margin-top:4px}
.ch-price{font-family:var(--mono);font-size:24px;font-weight:600;color:var(--accent);margin-top:16px}
.ch-price span{font-size:12px;color:var(--text3);font-weight:400}
.ch-body{padding:24px 28px}
.ch-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);font-size:13px}
.ch-row .l{color:var(--text3)}.ch-row .v{color:var(--text);font-family:var(--mono);font-size:12px}
.phase-label{font-family:var(--mono);font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--accent);margin:12px 0 4px}
.ch-btn{display:block;width:100%;padding:16px;font-family:var(--mono);font-size:12px;letter-spacing:1px;text-transform:uppercase;font-weight:600;border:none;cursor:pointer;transition:all 0.2s;margin-top:20px;text-decoration:none;text-align:center}
.challenge-card.feat .ch-btn{background:var(--accent);color:#fff}.challenge-card.feat .ch-btn:hover{background:var(--accent2)}
.challenge-card:not(.feat) .ch-btn{background:var(--bg3);color:var(--text2);border:1px solid var(--border2)}.challenge-card:not(.feat) .ch-btn:hover{border-color:var(--text3)}
/* RULES */
.rules-container{max-width:800px;margin:0 auto}
.rule-block{background:var(--bg2);border:1px solid var(--border);padding:28px;margin-bottom:16px}
.rule-block h3{font-family:var(--mono);font-size:13px;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:var(--accent);margin-bottom:16px;display:flex;align-items:center;gap:10px}
.rule-block h3 .n{width:24px;height:24px;display:flex;align-items:center;justify-content:center;background:var(--bg);border:1px solid var(--border2);font-size:11px;color:var(--text3)}
.rt{width:100%}.rt tr{border-bottom:1px solid var(--border)}.rt td{padding:10px 0;font-size:13px}.rt td:first-child{color:var(--text3);width:55%}.rt td:last-child{color:var(--text);font-family:var(--mono);font-size:12px;text-align:right}
/* DASHBOARD */
.dash-grid{display:grid;grid-template-columns:280px 1fr;gap:20px;max-width:1200px;margin:0 auto;padding:20px 32px}
.dash-sidebar{display:flex;flex-direction:column;gap:16px}
.dc{background:var(--bg2);border:1px solid var(--border);padding:20px}
.dc-label{font-family:var(--mono);font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text3);margin-bottom:8px}
.dc-val{font-family:var(--mono);font-size:28px;font-weight:700;color:#fff}
.dc-val.grn{color:var(--green)}.dc-val.red{color:var(--red)}
.dc-sub{font-family:var(--mono);font-size:11px;color:var(--text3);margin-top:4px}
.dash-main{display:flex;flex-direction:column;gap:16px}
.dp{background:var(--bg2);border:1px solid var(--border);padding:20px}
.dp-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.dp-title{font-family:var(--mono);font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--text3)}
.dp-badge{font-family:var(--mono);font-size:10px;padding:3px 10px;border:1px solid var(--border2);color:var(--text3)}
.tbl{width:100%;border-collapse:collapse}
.tbl th{font-family:var(--mono);font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text3);text-align:left;padding:8px 10px;border-bottom:1px solid var(--border2);font-weight:400}
.tbl td{font-family:var(--mono);font-size:12px;color:var(--text);padding:10px;border-bottom:1px solid var(--border)}
.pgrn{color:var(--green)}.pred{color:var(--red)}
.progress-bar{height:4px;background:var(--bg);margin-top:12px}.progress-fill{height:100%;background:var(--accent);transition:width 0.3s}
.badge{font-family:var(--mono);font-size:9px;letter-spacing:1px;text-transform:uppercase;padding:3px 8px;display:inline-block}
.badge-ok{background:rgba(64,176,128,0.1);color:var(--green);border:1px solid rgba(64,176,128,0.2)}
.badge-warn{background:rgba(200,160,48,0.1);color:var(--yellow);border:1px solid rgba(200,160,48,0.2)}
.badge-fail{background:rgba(208,72,72,0.1);color:var(--red);border:1px solid rgba(208,72,72,0.2)}
/* FORMS */
.form-group{margin-bottom:20px}
.form-label{font-family:var(--mono);font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);display:block;margin-bottom:6px}
.form-input,.form-select{width:100%;padding:12px;background:var(--bg);border:1px solid var(--border2);color:var(--text);font-family:var(--mono);font-size:13px;outline:none;transition:border-color 0.2s}
.form-input:focus,.form-select:focus{border-color:var(--accent)}
.form-select{appearance:none;cursor:pointer}
.form-select option{background:var(--bg2);color:var(--text)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-btn{padding:14px 24px;font-family:var(--mono);font-size:12px;letter-spacing:1px;text-transform:uppercase;font-weight:600;background:var(--accent);color:#fff;border:none;cursor:pointer;transition:background 0.2s;width:100%}
.form-btn:hover{background:var(--accent2)}
.form-btn.secondary{background:var(--bg3);border:1px solid var(--border2);color:var(--text2)}
.form-btn.danger{background:var(--red);color:#fff}
/* LOGIN */
.auth-box{max-width:380px;margin:100px auto;background:var(--bg2);border:1px solid var(--border);padding:40px}
.auth-box h2{font-family:var(--mono);font-size:18px;font-weight:600;letter-spacing:2px;color:#fff;margin-bottom:8px;text-transform:uppercase}
.auth-box .sub{font-size:13px;color:var(--text3);margin-bottom:32px}
.auth-toggle{text-align:center;margin-top:20px;font-family:var(--mono);font-size:11px;color:var(--text3)}
.auth-toggle a{color:var(--accent);text-decoration:none;cursor:pointer}
.msg{padding:12px;font-family:var(--mono);font-size:11px;margin-bottom:16px;display:none}
.msg-err{background:rgba(208,72,72,0.1);border:1px solid rgba(208,72,72,0.2);color:var(--red)}
.msg-ok{background:rgba(64,176,128,0.1);border:1px solid rgba(64,176,128,0.2);color:var(--green)}
/* EMPTY STATES */
.empty-state{text-align:center;padding:60px 20px}
.empty-state h3{font-family:var(--mono);font-size:16px;color:var(--text2);margin-bottom:12px}
.empty-state p{font-size:14px;color:var(--text3);margin-bottom:24px}
/* ADMIN */
.admin-tabs{display:flex;gap:0;margin-bottom:24px}
.admin-tabs button{font-family:var(--mono);font-size:11px;letter-spacing:1.5px;text-transform:uppercase;padding:10px 20px;background:var(--bg2);border:1px solid var(--border);color:var(--text3);cursor:pointer;transition:all 0.2s}
.admin-tabs button.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.admin-section{display:none}.admin-section.active{display:block}
/* FAQ */
.faq-container{max-width:700px;margin:0 auto}
.faq-item{border-bottom:1px solid var(--border)}
.faq-q{padding:20px 0;cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-family:var(--mono);font-size:13px;font-weight:500;color:var(--text)}
.faq-q:hover{color:#fff}
.faq-q .arrow{color:var(--text3);transition:transform 0.2s;font-size:14px}
.faq-q.open .arrow{transform:rotate(45deg)}
.faq-a{padding:0 0 20px;font-size:14px;color:var(--text2);line-height:1.7;display:none}
.faq-a.open{display:block}
/* LB */
.lb-table{width:100%;border-collapse:collapse;max-width:1000px;margin:0 auto}
.lb-table th{font-family:var(--mono);font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text3);text-align:left;padding:12px 16px;border-bottom:1px solid var(--border2);font-weight:400}
.lb-table td{font-family:var(--mono);font-size:12px;color:var(--text);padding:14px 16px;border-bottom:1px solid var(--border)}
.lb-table tr:hover td{background:var(--bg2)}
/* MODAL */
.modal-bg{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:200;display:none;align-items:center;justify-content:center}
.modal-bg.open{display:flex}
.modal{background:var(--bg2);border:1px solid var(--border);padding:32px;max-width:480px;width:90%;max-height:80vh;overflow-y:auto}
.modal h3{font-family:var(--mono);font-size:14px;font-weight:600;color:#fff;margin-bottom:20px;text-transform:uppercase;letter-spacing:1px}
.modal-close{float:right;background:none;border:none;color:var(--text3);font-size:18px;cursor:pointer}
@media(max-width:768px){.nav-links{display:none}.hero h1{font-size:32px}.steps{grid-template-columns:1fr}.challenge-set.active{grid-template-columns:1fr}.dash-grid{grid-template-columns:1fr}.form-row{grid-template-columns:1fr}}
</style>
</head>
<body>

<nav>
  <div class="nav-logo" onclick="showPage('home')"><span class="dot"></span>SEAL</div>
  <div class="nav-links">
    <a class="active" data-page="home">Home</a>
    <a data-page="challenges">Challenges</a>
    <a data-page="rules">Rules</a>
    <a data-page="dashboard" class="auth-only">Dashboard</a>
    <a data-page="leaderboard">Leaderboard</a>
    <a data-page="admin" class="admin-only">Admin</a>
    <a data-page="faq">FAQ</a>
  </div>
  <div class="nav-right">
    <span class="nav-user" id="nav-user"></span>
    <button class="nav-cta" id="nav-auth-btn" data-page="login">Sign In</button>
    <button class="nav-cta ghost" id="nav-logout-btn" style="display:none" onclick="logout()">Logout</button>
  </div>
</nav>

<!-- HOME -->
<div class="page active" id="page-home">
  <div class="hero">
    <div class="hero-tag">The first prediction market prop firm</div>
    <h1>Get Funded to Trade<br><span>Polymarket</span></h1>
    <p>Prove your edge. Pass the evaluation. Trade with our capital. Keep 80% of the profits. No risk to your own money.</p>
    <div class="hero-buttons">
      <button class="btn btn-primary" data-page="challenges">View Challenges →</button>
      <button class="btn btn-ghost" data-page="rules">How It Works</button>
    </div>
  </div>
  <div class="section">
    <div class="section-tag">How It Works</div>
    <h2>Three steps to funded trading</h2>
    <div class="steps">
      <div class="step"><div class="step-num">01</div><h3>Choose a Challenge</h3><p>Pick a one-step or two-step evaluation. Choose your account size — $500, $1,000, or $2,000. Pay the one-time fee.</p></div>
      <div class="step"><div class="step-num">02</div><h3>Pass the Evaluation</h3><p>Hit the profit target while staying within the 6% drawdown limit and meeting the consistency rule.</p></div>
      <div class="step"><div class="step-num">03</div><h3>Get Funded</h3><p>Trade with our capital. Keep 80% of your profits. 1% commission per trade. Withdraw when you're ready.</p></div>
    </div>
  </div>
  <footer><p>SEAL · Polymarket Prop Firm · 2026</p></footer>
</div>

<!-- CHALLENGES -->
<div class="page" id="page-challenges">
  <div class="section">
    <div class="section-tag">Choose Your Challenge</div>
    <h2>One-step or two-step evaluation</h2>
    <div class="challenge-toggle"><button class="active" id="t1">One Step</button><button id="t2">Two Step</button></div>
    <div class="challenge-set active" id="s1">
      <div class="challenge-card"><div class="ch-header"><div class="ch-size">$500</div><div class="ch-label">One-Step Evaluation</div><div class="ch-price">$79 <span>one-time</span></div></div><div class="ch-body"><div class="ch-row"><span class="l">Profit Target</span><span class="v">10% — $50</span></div><div class="ch-row"><span class="l">Max Drawdown</span><span class="v">6% — $30</span></div><div class="ch-row"><span class="l">Time Limit</span><span class="v">30 days</span></div><div class="ch-row"><span class="l">Min Trades</span><span class="v">5</span></div><div class="ch-row"><span class="l">Consistency</span><span class="v">20%</span></div><div class="ch-row"><span class="l">Commission</span><span class="v">1%</span></div><div class="ch-row"><span class="l">Profit Split</span><span class="v">80 / 20</span></div><a class="ch-btn" onclick="startChallenge('1step','500')">Start Challenge →</a></div></div>
      <div class="challenge-card feat"><div class="ch-header"><div class="ch-size">$1,000</div><div class="ch-label">One-Step Evaluation</div><div class="ch-price">$139 <span>one-time</span></div></div><div class="ch-body"><div class="ch-row"><span class="l">Profit Target</span><span class="v">10% — $100</span></div><div class="ch-row"><span class="l">Max Drawdown</span><span class="v">6% — $60</span></div><div class="ch-row"><span class="l">Time Limit</span><span class="v">30 days</span></div><div class="ch-row"><span class="l">Min Trades</span><span class="v">5</span></div><div class="ch-row"><span class="l">Consistency</span><span class="v">20%</span></div><div class="ch-row"><span class="l">Commission</span><span class="v">1%</span></div><div class="ch-row"><span class="l">Profit Split</span><span class="v">80 / 20</span></div><a class="ch-btn" onclick="startChallenge('1step','1000')">Start Challenge →</a></div></div>
      <div class="challenge-card"><div class="ch-header"><div class="ch-size">$2,000</div><div class="ch-label">One-Step Evaluation</div><div class="ch-price">$199 <span>one-time</span></div></div><div class="ch-body"><div class="ch-row"><span class="l">Profit Target</span><span class="v">10% — $200</span></div><div class="ch-row"><span class="l">Max Drawdown</span><span class="v">6% — $120</span></div><div class="ch-row"><span class="l">Time Limit</span><span class="v">30 days</span></div><div class="ch-row"><span class="l">Min Trades</span><span class="v">5</span></div><div class="ch-row"><span class="l">Consistency</span><span class="v">20%</span></div><div class="ch-row"><span class="l">Commission</span><span class="v">1%</span></div><div class="ch-row"><span class="l">Profit Split</span><span class="v">80 / 20</span></div><a class="ch-btn" onclick="startChallenge('1step','2000')">Start Challenge →</a></div></div>
    </div>
    <div class="challenge-set" id="s2">
      <div class="challenge-card"><div class="ch-header"><div class="ch-size">$500</div><div class="ch-label">Two-Step Evaluation</div><div class="ch-price">$59 <span>one-time</span></div></div><div class="ch-body"><div class="phase-label">Phase 1 — 30 Days</div><div class="ch-row"><span class="l">Profit Target</span><span class="v">6% — $30</span></div><div class="ch-row"><span class="l">Min Trades</span><span class="v">2</span></div><div class="ch-row"><span class="l">Consistency</span><span class="v">50%</span></div><div class="phase-label">Phase 2 — 30 Days</div><div class="ch-row"><span class="l">Profit Target</span><span class="v">4% — $20</span></div><div class="ch-row"><span class="l">Min Trades</span><span class="v">2</span></div><div class="ch-row"><span class="l">Consistency</span><span class="v">50%</span></div><div class="phase-label">Both Phases</div><div class="ch-row"><span class="l">Max Drawdown</span><span class="v">6% — $30</span></div><div class="ch-row"><span class="l">Commission</span><span class="v">1%</span></div><div class="ch-row"><span class="l">Profit Split</span><span class="v">80 / 20</span></div><a class="ch-btn" onclick="startChallenge('2step','500')">Start Challenge →</a></div></div>
      <div class="challenge-card feat"><div class="ch-header"><div class="ch-size">$1,000</div><div class="ch-label">Two-Step Evaluation</div><div class="ch-price">$119 <span>one-time</span></div></div><div class="ch-body"><div class="phase-label">Phase 1 — 30 Days</div><div class="ch-row"><span class="l">Profit Target</span><span class="v">6% — $60</span></div><div class="ch-row"><span class="l">Min Trades</span><span class="v">2</span></div><div class="ch-row"><span class="l">Consistency</span><span class="v">50%</span></div><div class="phase-label">Phase 2 — 30 Days</div><div class="ch-row"><span class="l">Profit Target</span><span class="v">4% — $40</span></div><div class="ch-row"><span class="l">Min Trades</span><span class="v">2</span></div><div class="ch-row"><span class="l">Consistency</span><span class="v">50%</span></div><div class="phase-label">Both Phases</div><div class="ch-row"><span class="l">Max Drawdown</span><span class="v">6% — $60</span></div><div class="ch-row"><span class="l">Commission</span><span class="v">1%</span></div><div class="ch-row"><span class="l">Profit Split</span><span class="v">80 / 20</span></div><a class="ch-btn" onclick="startChallenge('2step','1000')">Start Challenge →</a></div></div>
      <div class="challenge-card"><div class="ch-header"><div class="ch-size">$2,000</div><div class="ch-label">Two-Step Evaluation</div><div class="ch-price">$179 <span>one-time</span></div></div><div class="ch-body"><div class="phase-label">Phase 1 — 30 Days</div><div class="ch-row"><span class="l">Profit Target</span><span class="v">6% — $120</span></div><div class="ch-row"><span class="l">Min Trades</span><span class="v">2</span></div><div class="ch-row"><span class="l">Consistency</span><span class="v">50%</span></div><div class="phase-label">Phase 2 — 30 Days</div><div class="ch-row"><span class="l">Profit Target</span><span class="v">4% — $80</span></div><div class="ch-row"><span class="l">Min Trades</span><span class="v">2</span></div><div class="ch-row"><span class="l">Consistency</span><span class="v">50%</span></div><div class="phase-label">Both Phases</div><div class="ch-row"><span class="l">Max Drawdown</span><span class="v">6% — $120</span></div><div class="ch-row"><span class="l">Commission</span><span class="v">1%</span></div><div class="ch-row"><span class="l">Profit Split</span><span class="v">80 / 20</span></div><a class="ch-btn" onclick="startChallenge('2step','2000')">Start Challenge →</a></div></div>
    </div>
  </div>
  <footer><p>SEAL · Polymarket Prop Firm · 2026</p></footer>
</div>

<!-- RULES -->
<div class="page" id="page-rules">
  <div class="section">
    <div class="section-tag">Evaluation Rules</div>
    <h2>Know the rules before you start</h2>
    <div class="rules-container">
      <div class="rule-block"><h3><span class="n">1</span> One-Step Evaluation</h3><table class="rt"><tr><td>Profit Target</td><td>10%</td></tr><tr><td>Max Drawdown</td><td>6% trailing</td></tr><tr><td>Time Limit</td><td>30 calendar days</td></tr><tr><td>Minimum Trades</td><td>5</td></tr><tr><td>Consistency Rule</td><td>20% — no single trade > 20% of total profit</td></tr></table></div>
      <div class="rule-block"><h3><span class="n">2</span> Two-Step Evaluation</h3><table class="rt"><tr><td>Phase 1 Target</td><td>6%</td></tr><tr><td>Phase 2 Target</td><td>4%</td></tr><tr><td>Max Drawdown (both)</td><td>6% trailing</td></tr><tr><td>Time (each phase)</td><td>30 calendar days</td></tr><tr><td>Min Trades (each)</td><td>2</td></tr><tr><td>Consistency (both)</td><td>50% per phase</td></tr></table></div>
      <div class="rule-block"><h3><span class="n">3</span> Pricing</h3><table class="rt"><tr><td>$500 One-Step</td><td>$79</td></tr><tr><td>$1,000 One-Step</td><td>$139</td></tr><tr><td>$2,000 One-Step</td><td>$199</td></tr><tr><td>$500 Two-Step</td><td>$59</td></tr><tr><td>$1,000 Two-Step</td><td>$119</td></tr><tr><td>$2,000 Two-Step</td><td>$179</td></tr></table></div>
      <div class="rule-block"><h3><span class="n">4</span> Commission & Splits</h3><table class="rt"><tr><td>Commission</td><td>1% per trade</td></tr><tr><td>Profit Split</td><td>80% trader / 20% firm</td></tr><tr><td>Withdrawal min</td><td>$50</td></tr><tr><td>Withdrawal cycle</td><td>Bi-weekly</td></tr><tr><td>Scaling</td><td>+25% after 3 profitable months</td></tr></table></div>
    </div>
  </div>
  <footer><p>SEAL · Polymarket Prop Firm · 2026</p></footer>
</div>

<!-- DASHBOARD -->
<div class="page" id="page-dashboard">
  <div id="dash-content"></div>
  <footer><p>SEAL · Polymarket Prop Firm · 2026</p></footer>
</div>

<!-- LEADERBOARD -->
<div class="page" id="page-leaderboard">
  <div class="section">
    <div class="section-tag">Funded Traders</div>
    <h2>Leaderboard</h2>
    <div id="lb-content"><p style="text-align:center;color:var(--text3);font-family:var(--mono);font-size:12px">Loading...</p></div>
  </div>
  <footer><p>SEAL · Polymarket Prop Firm · 2026</p></footer>
</div>

<!-- ADMIN -->
<div class="page" id="page-admin">
  <div class="section">
    <div class="section-tag">Admin Panel</div>
    <h2>Manage Platform</h2>
    <div class="admin-tabs">
      <button class="active" onclick="showAdminTab('users')">Users</button>
      <button onclick="showAdminTab('evals')">Evaluations</button>
      <button onclick="showAdminTab('create')">Create Eval</button>
    </div>
    <div class="admin-section active" id="admin-users"></div>
    <div class="admin-section" id="admin-evals"></div>
    <div class="admin-section" id="admin-create">
      <div class="dp" style="max-width:500px">
        <h3 style="font-family:var(--mono);font-size:13px;color:var(--accent);margin-bottom:20px;text-transform:uppercase;letter-spacing:1px">Create Evaluation</h3>
        <div class="msg msg-err" id="admin-create-err"></div>
        <div class="msg msg-ok" id="admin-create-ok"></div>
        <div class="form-group"><label class="form-label">User Email</label><input class="form-input" id="ac-email" placeholder="user@email.com"></div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">Type</label><select class="form-select" id="ac-type"><option value="1-step">One-Step</option><option value="2-step">Two-Step</option></select></div>
          <div class="form-group"><label class="form-label">Account Size</label><select class="form-select" id="ac-size"><option value="500">$500</option><option value="1000">$1,000</option><option value="2000">$2,000</option></select></div>
        </div>
        <button class="form-btn" onclick="adminCreateEval()">Create Evaluation</button>
      </div>
    </div>
  </div>
  <footer><p>SEAL · Polymarket Prop Firm · 2026</p></footer>
</div>

<!-- FAQ -->
<div class="page" id="page-faq">
  <div class="section">
    <div class="section-tag">Frequently Asked</div>
    <h2>FAQ</h2>
    <div class="faq-container">
      <div class="faq-item"><div class="faq-q">What's the difference between one-step and two-step? <span class="arrow">+</span></div><div class="faq-a">One-step: single phase, 10% target, 5 min trades, 20% consistency, 30 days. Two-step: two phases (6% then 4%), 2 min trades per phase, 50% consistency per phase, 30 days each. Two-step is $20 cheaper. Both have 6% max drawdown and 1% commission.</div></div>
      <div class="faq-item"><div class="faq-q">What is the consistency rule? <span class="arrow">+</span></div><div class="faq-a">Prevents passing on one lucky trade. One-step: no trade > 20% of total profit. Two-step: no trade > 50% of phase profit. Proves repeatable edge.</div></div>
      <div class="faq-item"><div class="faq-q">How does drawdown work? <span class="arrow">+</span></div><div class="faq-a">6% trailing from high-water mark. Includes unrealized positions. Breach = instant fail. Repurchase any time.</div></div>
      <div class="faq-item"><div class="faq-q">What happens if I fail? <span class="arrow">+</span></div><div class="faq-a">Repurchase immediately. No waiting. Many funded traders failed first.</div></div>
      <div class="faq-item"><div class="faq-q">How do payouts work? <span class="arrow">+</span></div><div class="faq-a">80/20 split. Bi-weekly withdrawals, $50 min. Processed within 48 hours.</div></div>
      <div class="faq-item"><div class="faq-q">What's the scaling plan? <span class="arrow">+</span></div><div class="faq-a">+25% capital after 3 consecutive profitable months. No cap.</div></div>
    </div>
  </div>
  <footer><p>SEAL · Polymarket Prop Firm · 2026</p></footer>
</div>

<!-- LOGIN / REGISTER -->
<div class="page" id="page-login">
  <div class="auth-box" id="auth-login">
    <h2>Sign In</h2>
    <div class="sub">Access your evaluation account</div>
    <div class="msg msg-err" id="login-err"></div>
    <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="login-email" type="email" placeholder="trader@email.com"></div>
    <div class="form-group"><label class="form-label">Password</label><input class="form-input" id="login-pass" type="password" placeholder="••••••••"></div>
    <button class="form-btn" onclick="login()">Sign In →</button>
    <div class="auth-toggle">Don't have an account? <a onclick="toggleAuth('register')">Create one</a></div>
  </div>
  <div class="auth-box" id="auth-register" style="display:none">
    <h2>Create Account</h2>
    <div class="sub">Start your trading journey</div>
    <div class="msg msg-err" id="reg-err"></div>
    <div class="msg msg-ok" id="reg-ok"></div>
    <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="reg-email" type="email" placeholder="trader@email.com"></div>
    <div class="form-group"><label class="form-label">Password</label><input class="form-input" id="reg-pass" type="password" placeholder="Min 6 characters"></div>
    <div class="form-group"><label class="form-label">Confirm Password</label><input class="form-input" id="reg-pass2" type="password" placeholder="••••••••"></div>
    <button class="form-btn" onclick="register()">Create Account →</button>
    <div class="auth-toggle">Already have an account? <a onclick="toggleAuth('login')">Sign in</a></div>
  </div>
</div>

<!-- TRADE MODAL -->
<div class="modal-bg" id="trade-modal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('trade-modal')">✕</button>
    <h3 id="trade-modal-title">Open Trade</h3>
    <div class="msg msg-err" id="trade-err"></div>
    <div class="form-group"><label class="form-label">Contract Name</label><input class="form-input" id="tr-name" placeholder="e.g. Fed Rate Hold Jun 2026"></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Side</label><select class="form-select" id="tr-side"><option value="YES">YES</option><option value="NO">NO</option></select></div>
      <div class="form-group"><label class="form-label">Size ($)</label><input class="form-input" id="tr-size" type="number" placeholder="50"></div>
    </div>
    <div class="form-group"><label class="form-label">Entry Price (¢)</label><input class="form-input" id="tr-entry" type="number" step="0.1" placeholder="e.g. 72.5"></div>
    <button class="form-btn" onclick="openTrade()">Open Trade</button>
  </div>
</div>

<!-- CLOSE TRADE MODAL -->
<div class="modal-bg" id="close-modal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('close-modal')">✕</button>
    <h3>Close Trade</h3>
    <div class="msg msg-err" id="close-err"></div>
    <p id="close-info" style="font-family:var(--mono);font-size:12px;color:var(--text2);margin-bottom:16px"></p>
    <div class="form-group"><label class="form-label">Exit Price (¢)</label><input class="form-input" id="cl-exit" type="number" step="0.1" placeholder="e.g. 85.0"></div>
    <button class="form-btn" onclick="closeTrade()">Close Trade</button>
  </div>
</div>

<script>
// ==========================================
// SUPABASE INIT
// ==========================================
let sb;
try { sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch(e) { console.warn('Supabase not configured yet'); }

let currentUser = null;
let currentProfile = null;
let activeEval = null;
let closingTradeId = null;

// ==========================================
// AUTH
// ==========================================
async function checkSession() {
  if (!sb) return;
  const { data: { session } } = await sb.auth.getSession();
  if (session) {
    currentUser = session.user;
    await loadProfile();
    updateAuthUI(true);
  } else {
    updateAuthUI(false);
  }
}

async function loadProfile() {
  if (!sb || !currentUser) return;
  const { data } = await sb.from('profiles').select('*').eq('id', currentUser.id).single();
  if (data) currentProfile = data;
}

function updateAuthUI(loggedIn) {
  const navUser = document.getElementById('nav-user');
  const authBtn = document.getElementById('nav-auth-btn');
  const logoutBtn = document.getElementById('nav-logout-btn');
  document.querySelectorAll('.auth-only').forEach(el => el.style.display = loggedIn ? '' : 'none');
  document.querySelectorAll('.admin-only').forEach(el => el.style.display = (loggedIn && currentProfile?.is_admin) ? '' : 'none');
  if (loggedIn) {
    navUser.textContent = currentProfile?.display_name || currentUser.email.split('@')[0];
    navUser.style.display = '';
    authBtn.style.display = 'none';
    logoutBtn.style.display = '';
  } else {
    navUser.style.display = 'none';
    authBtn.style.display = '';
    logoutBtn.style.display = 'none';
  }
}

async function login() {
  const email = document.getElementById('login-email').value.trim();
  const pass = document.getElementById('login-pass').value;
  const errEl = document.getElementById('login-err');
  errEl.style.display = 'none';
  if (!email || !pass) { showMsg(errEl, 'Please enter email and password', 'err'); return; }
  const { error } = await sb.auth.signInWithPassword({ email, password: pass });
  if (error) { showMsg(errEl, error.message, 'err'); return; }
  await checkSession();
  showPage('dashboard');
}

async function register() {
  const email = document.getElementById('reg-email').value.trim();
  const pass = document.getElementById('reg-pass').value;
  const pass2 = document.getElementById('reg-pass2').value;
  const errEl = document.getElementById('reg-err');
  const okEl = document.getElementById('reg-ok');
  errEl.style.display = 'none'; okEl.style.display = 'none';
  if (!email || !pass) { showMsg(errEl, 'Please fill in all fields', 'err'); return; }
  if (pass !== pass2) { showMsg(errEl, 'Passwords do not match', 'err'); return; }
  if (pass.length < 6) { showMsg(errEl, 'Password must be at least 6 characters', 'err'); return; }
  const { error } = await sb.auth.signUp({ email, password: pass });
  if (error) { showMsg(errEl, error.message, 'err'); return; }
  showMsg(okEl, 'Account created! You can now sign in.', 'ok');
  setTimeout(() => toggleAuth('login'), 1500);
}

async function logout() {
  if (sb) await sb.auth.signOut();
  currentUser = null; currentProfile = null; activeEval = null;
  updateAuthUI(false);
  showPage('home');
}

function toggleAuth(mode) {
  document.getElementById('auth-login').style.display = mode === 'login' ? '' : 'none';
  document.getElementById('auth-register').style.display = mode === 'register' ? '' : 'none';
}

function showMsg(el, text, type) {
  el.textContent = text;
  el.className = 'msg msg-' + type;
  el.style.display = 'block';
}

// ==========================================
// DASHBOARD
// ==========================================
async function loadDashboard() {
  const container = document.getElementById('dash-content');
  if (!currentUser) { container.innerHTML = '<div class="empty-state"><h3>Sign in to view your dashboard</h3><p>Create an account or sign in to track your evaluations.</p><button class="btn btn-primary" data-page="login">Sign In</button></div>'; bindDataPage(); return; }
  
  // Load active evaluation
  const { data: evals } = await sb.from('evaluations').select('*').eq('user_id', currentUser.id).in('status', ['active', 'funded']).order('created_at', { ascending: false }).limit(1);
  
  if (!evals || evals.length === 0) {
    container.innerHTML = '<div class="empty-state"><h3>No Active Evaluation</h3><p>Start a challenge to begin your funded trading journey.</p><button class="btn btn-primary" data-page="challenges">View Challenges →</button></div>';
    bindDataPage(); return;
  }
  
  activeEval = evals[0];
  const e = activeEval;
  const { data: trades } = await sb.from('trades').select('*').eq('evaluation_id', e.id).order('opened_at', { ascending: false });
  const openTrades = (trades || []).filter(t => t.status === 'open');
  const closedTrades = (trades || []).filter(t => t.status === 'closed');
  
  const daysUsed = Math.floor((Date.now() - new Date(e.created_at).getTime()) / 86400000);
  const daysTotal = Math.floor((new Date(e.expires_at).getTime() - new Date(e.created_at).getTime()) / 86400000);
  const profit = e.balance - e.starting_balance;
  const profitTarget = e.starting_balance * (e.profit_target_pct / 100);
  const ddUsed = e.high_water_mark > 0 ? ((e.high_water_mark - e.balance) / e.high_water_mark * 100) : 0;
  const ddLimit = e.max_drawdown_pct;
  const profitPct = profitTarget > 0 ? Math.min(100, (Math.max(0, profit) / profitTarget) * 100) : 0;
  
  // Consistency check
  let consistencyOk = true;
  let largestPct = 0;
  if (e.total_profit > 0 && closedTrades.length > 0) {
    const maxTrade = Math.max(...closedTrades.filter(t => t.pnl > 0).map(t => t.pnl), 0);
    largestPct = (maxTrade / e.total_profit) * 100;
    consistencyOk = largestPct <= e.consistency_rule_pct;
  }
  
  const typeLabel = e.eval_type === '1-step' ? 'One-Step' : `Two-Step · Phase ${e.phase}`;
  const statusBadge = e.status === 'funded' ? '<span class="badge badge-ok">FUNDED</span>' : 
    (e.status === 'active' ? `<span class="badge badge-ok">${typeLabel} · Day ${daysUsed} of ${daysTotal}</span>` : 
    `<span class="badge badge-fail">${e.status.toUpperCase()}</span>`);
  
  container.innerHTML = `
    <div class="dash-grid">
      <div class="dash-sidebar">
        <div class="dc"><div class="dc-label">Account</div>${statusBadge}<div class="progress-bar" style="margin-top:12px"><div class="progress-fill" style="width:${(daysUsed/daysTotal)*100}%"></div></div></div>
        <div class="dc"><div class="dc-label">Balance</div><div class="dc-val">${fmt(e.balance)}</div><div class="dc-sub">Starting: ${fmt(e.starting_balance)}</div></div>
        <div class="dc"><div class="dc-label">Profit Target</div><div class="dc-val ${profit>=0?'grn':'red'}">${fmt(Math.max(0,profit))} / ${fmt(profitTarget)}</div><div class="dc-sub">${e.profit_target_pct}% target</div><div class="progress-bar"><div class="progress-fill" style="width:${profitPct}%"></div></div></div>
        <div class="dc"><div class="dc-label">Drawdown Used</div><div class="dc-val">${ddUsed.toFixed(1)}%</div><div class="dc-sub">Max: ${ddLimit}%</div><div class="progress-bar"><div class="progress-fill" style="width:${(ddUsed/ddLimit)*100}%;${ddUsed>ddLimit*0.7?'background:var(--red)':''}"></div></div></div>
        <div class="dc"><div class="dc-label">Trades</div><div class="dc-val">${e.trades_count} / ${e.min_trades} min</div></div>
        <div class="dc"><div class="dc-label">Consistency</div><div class="dc-val ${consistencyOk?'grn':'red'}">${consistencyOk?'✓ Passing':'✕ Failing'}</div><div class="dc-sub">Largest: ${largestPct.toFixed(1)}% (max ${e.consistency_rule_pct}%)</div></div>
      </div>
      <div class="dash-main">
        <div class="dp">
          <div class="dp-header"><div class="dp-title">Open Positions</div><div style="display:flex;gap:8px"><span class="dp-badge">${openTrades.length} Active</span><button class="form-btn" style="width:auto;padding:6px 16px;font-size:10px" onclick="openModal('trade-modal')">+ New Trade</button></div></div>
          ${openTrades.length ? `<table class="tbl"><thead><tr><th>Contract</th><th>Side</th><th>Size</th><th>Entry</th><th>Commission</th><th>Action</th></tr></thead><tbody>${openTrades.map(t=>`<tr><td>${t.contract_name}</td><td>${t.side}</td><td>${fmt(t.trade_size)}</td><td>${t.entry_price*100}¢</td><td>${fmt(t.commission)}</td><td><button class="form-btn secondary" style="width:auto;padding:4px 12px;font-size:9px" onclick="openCloseModal('${t.id}','${t.contract_name}',${t.entry_price},'${t.side}',${t.trade_size})">Close</button></td></tr>`).join('')}</tbody></table>` : '<p style="color:var(--text3);font-family:var(--mono);font-size:12px">No open positions</p>'}
        </div>
        <div class="dp">
          <div class="dp-header"><div class="dp-title">Trade History</div><span class="dp-badge">${closedTrades.length} Closed</span></div>
          ${closedTrades.length ? `<table class="tbl"><thead><tr><th>Contract</th><th>Side</th><th>Size</th><th>Entry</th><th>Exit</th><th>P&L</th></tr></thead><tbody>${closedTrades.map(t=>`<tr><td>${t.contract_name}</td><td>${t.side}</td><td>${fmt(t.trade_size)}</td><td>${(t.entry_price*100).toFixed(1)}¢</td><td>${(t.exit_price*100).toFixed(1)}¢</td><td class="${t.pnl>=0?'pgrn':'pred'}">${t.pnl>=0?'+':''}${fmt(t.pnl)}</td></tr>`).join('')}</tbody></table>` : '<p style="color:var(--text3);font-family:var(--mono);font-size:12px">No closed trades yet</p>'}
        </div>
      </div>
    </div>`;
  bindDataPage();
}

function fmt(n) { return '$' + Number(n).toFixed(2); }

// ==========================================
// TRADES
// ==========================================
async function openTrade() {
  const errEl = document.getElementById('trade-err');
  errEl.style.display = 'none';
  if (!activeEval) { showMsg(errEl, 'No active evaluation', 'err'); return; }
  
  const name = document.getElementById('tr-name').value.trim();
  const side = document.getElementById('tr-side').value;
  const size = parseFloat(document.getElementById('tr-size').value);
  const entry = parseFloat(document.getElementById('tr-entry').value) / 100; // convert cents to decimal
  
  if (!name) { showMsg(errEl, 'Enter contract name', 'err'); return; }
  if (!size || size <= 0) { showMsg(errEl, 'Enter valid size', 'err'); return; }
  if (!entry || entry <= 0 || entry >= 1) { showMsg(errEl, 'Entry price must be between 1-99¢', 'err'); return; }
  if (size > activeEval.balance * 0.15) { showMsg(errEl, 'Max position size is 15% of balance', 'err'); return; }
  
  const commission = size * 0.01; // 1% commission
  
  const { error } = await sb.from('trades').insert({
    evaluation_id: activeEval.id,
    user_id: currentUser.id,
    contract_name: name,
    side: side,
    trade_size: size,
    entry_price: entry,
    commission: commission,
    status: 'open'
  });
  
  if (error) { showMsg(errEl, error.message, 'err'); return; }
  
  // Deduct commission from balance
  await sb.from('evaluations').update({
    balance: activeEval.balance - commission
  }).eq('id', activeEval.id);
  
  closeModal('trade-modal');
  document.getElementById('tr-name').value = '';
  document.getElementById('tr-size').value = '';
  document.getElementById('tr-entry').value = '';
  await loadDashboard();
}

function openCloseModal(tradeId, name, entry, side, size) {
  closingTradeId = tradeId;
  document.getElementById('close-info').textContent = `${name} · ${side} · ${fmt(size)} @ ${(entry*100).toFixed(1)}¢`;
  document.getElementById('cl-exit').value = '';
  document.getElementById('close-err').style.display = 'none';
  openModal('close-modal');
}

async function closeTrade() {
  const errEl = document.getElementById('close-err');
  errEl.style.display = 'none';
  const exitPrice = parseFloat(document.getElementById('cl-exit').value) / 100;
  if (!exitPrice || exitPrice <= 0 || exitPrice >= 1) { showMsg(errEl, 'Exit price must be 1-99¢', 'err'); return; }
  
  // Get the trade
  const { data: trade } = await sb.from('trades').select('*').eq('id', closingTradeId).single();
  if (!trade) { showMsg(errEl, 'Trade not found', 'err'); return; }
  
  // Calculate P&L
  let pnl;
  if (trade.side === 'YES') {
    pnl = (exitPrice - trade.entry_price) * (trade.trade_size / trade.entry_price);
  } else {
    pnl = (trade.entry_price - exitPrice) * (trade.trade_size / (1 - trade.entry_price));
  }
  pnl = Math.round(pnl * 100) / 100;
  
  // Update trade
  await sb.from('trades').update({
    exit_price: exitPrice,
    pnl: pnl,
    status: 'closed',
    closed_at: new Date().toISOString()
  }).eq('id', closingTradeId);
  
  // Update evaluation
  const e = activeEval;
  const newBalance = e.balance + pnl;
  const newHWM = Math.max(e.high_water_mark, newBalance);
  const newTotalProfit = pnl > 0 ? e.total_profit + pnl : e.total_profit;
  const newTotalLoss = pnl < 0 ? e.total_loss + Math.abs(pnl) : e.total_loss;
  const newLargest = pnl > 0 ? Math.max(e.largest_trade_profit, pnl) : e.largest_trade_profit;
  
  const updateData = {
    balance: newBalance,
    high_water_mark: newHWM,
    trades_count: e.trades_count + 1,
    total_profit: newTotalProfit,
    total_loss: newTotalLoss,
    largest_trade_profit: newLargest
  };
  
  // Check drawdown breach
  const ddPct = newHWM > 0 ? ((newHWM - newBalance) / newHWM) * 100 : 0;
  if (ddPct >= e.max_drawdown_pct) {
    updateData.status = 'failed';
  }
  
  // Check if target hit
  const profitPct = ((newBalance - e.starting_balance) / e.starting_balance) * 100;
  if (profitPct >= e.profit_target_pct && e.trades_count + 1 >= e.min_trades) {
    // Check consistency
    const consistencyPct = newTotalProfit > 0 ? (newLargest / newTotalProfit) * 100 : 0;
    if (consistencyPct <= e.consistency_rule_pct) {
      if (e.eval_type === '1-step') {
        updateData.status = 'passed';
      } else if (e.phase === 1) {
        // Move to phase 2
        updateData.phase = 2;
        updateData.profit_target_pct = 4;
        updateData.total_profit = 0;
        updateData.total_loss = 0;
        updateData.largest_trade_profit = 0;
        updateData.trades_count = 0;
        updateData.balance = e.starting_balance; // Reset balance for phase 2
        updateData.high_water_mark = e.starting_balance;
        updateData.expires_at = new Date(Date.now() + 30 * 86400000).toISOString();
      } else {
        updateData.status = 'passed';
      }
    }
  }
  
  await sb.from('evaluations').update(updateData).eq('id', e.id);
  
  closeModal('close-modal');
  await loadDashboard();
}

// ==========================================
// LEADERBOARD
// ==========================================
async function loadLeaderboard() {
  const container = document.getElementById('lb-content');
  if (!sb) { container.innerHTML = '<p style="text-align:center;color:var(--text3);font-family:var(--mono);font-size:12px">Configure Supabase to view leaderboard</p>'; return; }
  
  const { data } = await sb.from('leaderboard').select('*');
  if (!data || data.length === 0) {
    container.innerHTML = '<p style="text-align:center;color:var(--text3);font-family:var(--mono);font-size:12px">No funded traders yet. Be the first.</p>';
    return;
  }
  
  container.innerHTML = `<table class="lb-table"><thead><tr><th>Rank</th><th>Trader</th><th>Account</th><th>Type</th><th>Return</th><th>Trades</th><th>Status</th></tr></thead><tbody>${data.map((r,i) => `<tr><td style="font-weight:700;${i<3?'color:'+(i===0?'#d4a840':i===1?'#a0a8b8':'#b87840'):''}">${i+1}</td><td>${r.trader}</td><td>$${r.account_size}</td><td>${r.eval_type}</td><td style="color:var(--green)">+${r.return_pct}%</td><td>${r.trades_count}</td><td><span class="badge badge-ok">${r.status}</span></td></tr>`).join('')}</tbody></table>`;
}

// ==========================================
// ADMIN
// ==========================================
async function loadAdmin() {
  if (!currentProfile?.is_admin) return;
  
  // Load users
  const { data: users } = await sb.from('profiles').select('*').order('created_at', { ascending: false });
  const usersEl = document.getElementById('admin-users');
  usersEl.innerHTML = users && users.length ? `<table class="tbl"><thead><tr><th>Email</th><th>Name</th><th>Admin</th><th>Created</th></tr></thead><tbody>${users.map(u => `<tr><td>${u.email}</td><td>${u.display_name}</td><td>${u.is_admin?'<span class="badge badge-ok">ADMIN</span>':'—'}</td><td>${new Date(u.created_at).toLocaleDateString()}</td></tr>`).join('')}</tbody></table>` : '<p style="color:var(--text3)">No users</p>';
  
  // Load all evaluations
  const { data: evals } = await sb.from('evaluations').select('*, profiles(email)').order('created_at', { ascending: false });
  const evalsEl = document.getElementById('admin-evals');
  evalsEl.innerHTML = evals && evals.length ? `<div style="overflow-x:auto"><table class="tbl"><thead><tr><th>User</th><th>Type</th><th>Size</th><th>Phase</th><th>Balance</th><th>Status</th><th>Created</th></tr></thead><tbody>${evals.map(e => `<tr><td>${e.profiles?.email||'—'}</td><td>${e.eval_type}</td><td>$${e.account_size}</td><td>${e.phase}</td><td>${fmt(e.balance)}</td><td><span class="badge ${e.status==='active'?'badge-ok':e.status==='funded'?'badge-ok':e.status==='passed'?'badge-warn':'badge-fail'}">${e.status}</span></td><td>${new Date(e.created_at).toLocaleDateString()}</td></tr>`).join('')}</tbody></table></div>` : '<p style="color:var(--text3)">No evaluations</p>';
}

async function adminCreateEval() {
  const errEl = document.getElementById('admin-create-err');
  const okEl = document.getElementById('admin-create-ok');
  errEl.style.display = 'none'; okEl.style.display = 'none';
  
  const email = document.getElementById('ac-email').value.trim();
  const type = document.getElementById('ac-type').value;
  const size = parseInt(document.getElementById('ac-size').value);
  
  if (!email) { showMsg(errEl, 'Enter user email', 'err'); return; }
  
  // Find user
  const { data: profiles } = await sb.from('profiles').select('id').eq('email', email);
  if (!profiles || profiles.length === 0) { showMsg(errEl, 'User not found', 'err'); return; }
  const userId = profiles[0].id;
  
  // Determine rules
  const isOneStep = type === '1-step';
  const profitTarget = isOneStep ? 10 : 6;
  const consistency = isOneStep ? 20 : 50;
  const minTrades = isOneStep ? 5 : 2;
  
  const { error } = await sb.from('evaluations').insert({
    user_id: userId,
    eval_type: type,
    account_size: size,
    phase: 1,
    status: 'active',
    starting_balance: size,
    balance: size,
    high_water_mark: size,
    profit_target_pct: profitTarget,
    max_drawdown_pct: 6,
    consistency_rule_pct: consistency,
    min_trades: minTrades,
    expires_at: new Date(Date.now() + 30 * 86400000).toISOString()
  });
  
  if (error) { showMsg(errEl, error.message, 'err'); return; }
  showMsg(okEl, `Evaluation created for ${email}: ${type} $${size}`, 'ok');
  document.getElementById('ac-email').value = '';
  await loadAdmin();
}

function showAdminTab(tab) {
  document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.admin-tabs button').forEach(b => b.classList.remove('active'));
  document.getElementById('admin-' + tab).classList.add('active');
  event.target.classList.add('active');
}

// ==========================================
// STRIPE / CHALLENGES
// ==========================================
function startChallenge(type, size) {
  const key = type + '-' + size;
  const link = STRIPE_LINKS[key];
  if (link && !link.startsWith('STRIPE_LINK')) {
    window.location.href = link;
  } else {
    // Stripe not configured — redirect to login
    if (!currentUser) {
      showPage('login');
    } else {
      alert('Payment links not configured yet. Contact admin to activate your evaluation.');
    }
  }
}

// ==========================================
// NAVIGATION
// ==========================================
function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
  const page = document.getElementById('page-' + id);
  if (page) { page.classList.add('active'); window.scrollTo(0, 0); }
  const link = document.querySelector('.nav-links a[data-page="' + id + '"]');
  if (link) link.classList.add('active');
  
  // Load data for certain pages
  if (id === 'dashboard') loadDashboard();
  if (id === 'leaderboard') loadLeaderboard();
  if (id === 'admin' && currentProfile?.is_admin) loadAdmin();
}

function bindDataPage() {
  document.querySelectorAll('[data-page]').forEach(el => {
    if (!el._bound) {
      el.addEventListener('click', e => { e.preventDefault(); showPage(el.getAttribute('data-page')); });
      el._bound = true;
    }
  });
}

function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// ==========================================
// INIT
// ==========================================
document.querySelectorAll('[data-page]').forEach(el => {
  el.addEventListener('click', e => { e.preventDefault(); showPage(el.getAttribute('data-page')); });
  el._bound = true;
});
document.querySelectorAll('.faq-q').forEach(q => {
  q.addEventListener('click', () => { q.classList.toggle('open'); q.nextElementSibling.classList.toggle('open'); });
});
document.getElementById('t1').addEventListener('click', () => { document.getElementById('t1').classList.add('active'); document.getElementById('t2').classList.remove('active'); document.getElementById('s1').classList.add('active'); document.getElementById('s2').classList.remove('active'); });
document.getElementById('t2').addEventListener('click', () => { document.getElementById('t2').classList.add('active'); document.getElementById('t1').classList.remove('active'); document.getElementById('s2').classList.add('active'); document.getElementById('s1').classList.remove('active'); });

// Close modals on bg click
document.querySelectorAll('.modal-bg').forEach(bg => {
  bg.addEventListener('click', e => { if (e.target === bg) bg.classList.remove('open'); });
});

// Check URL params for Stripe redirect
if (window.location.search.includes('payment=success')) {
  // Show success message after Stripe payment
  alert('Payment received! Your evaluation will be activated shortly. Sign in to check your dashboard.');
  window.history.replaceState({}, '', window.location.pathname);
}

// Init auth
checkSession();
</script>
</body>
</html>
